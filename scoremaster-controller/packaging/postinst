#!/bin/sh
set -e
. /usr/share/debconf/confmodule

if [ "$1" = "configure" ]; then
    echo "Configuring ScoreMaster Controller..."
    
    # Get the selected interface from debconf
    db_get scoremaster-controller/interface
    SELECTED_INTERFACE="$RET"
    
    if [ "$SELECTED_INTERFACE" = "None (Disable ColorLight)" ]; then
        SELECTED_INTERFACE="disabled"
        CLI_ARGS="-s"
    else
        CLI_ARGS="-c $SELECTED_INTERFACE -s"
    fi

    # Create the config directory
    mkdir -p /etc/scoremaster-controller
    
    # Create the data directory
    mkdir -p /var/lib/scoremaster-controller
    chown scoreboard:scoreboard /var/lib/scoremaster-controller
    chmod 755 /var/lib/scoremaster-controller

    # Write the configuration file with comments
    cat > /etc/scoremaster-controller/config.env <<EOF
# ScoreMaster Controller Configuration
# -----------------------------------

# The network interface connected to the ColorLight LED sender card.
# Set to 'disabled' to turn off LED output.
SCOREMASTER_INTERFACE=$SELECTED_INTERFACE

# Arguments passed to the scoremaster-controller binary.
# After changing these, restart with: sudo systemctl restart scoremaster-controller
SCOREMASTER_ARGS="$CLI_ARGS"
EOF

    echo "Setting permissions and capabilities..."
    
    # Ensure the binary is owned by root but executable by others
    chown root:scoreboard /usr/bin/scoremaster-controller
    chmod 755 /usr/bin/scoremaster-controller

    # Grant raw socket capabilities to the binary
    if command -v setcap > /dev/null; then
        setcap 'cap_net_raw,cap_net_admin=eip' /usr/bin/scoremaster-controller || echo "Warning: Failed to set capabilities."
    else
        echo "Warning: setcap command not found. LED support may require root."
    fi

    # Enable and start the services
    echo "Enabling ScoreMaster services and update timer..."
    systemctl daemon-reload || true
    systemctl enable scoremaster-controller.service || true
    systemctl start scoremaster-controller.service || true
    
    systemctl enable scoremaster-update.timer || true
    systemctl start scoremaster-update.timer || true

    echo "--------------------------------------------------------"
    echo " ScoreMaster Controller installation complete!"
    echo " To change the network interface later, run:"
    echo "   sudo dpkg-reconfigure scoremaster-controller"
    echo "--------------------------------------------------------"
fi

exit 0
